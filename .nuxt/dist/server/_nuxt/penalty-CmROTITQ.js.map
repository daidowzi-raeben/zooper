{"version":3,"file":"penalty-CmROTITQ.js","sources":["../../../../pages/penalty.vue"],"sourcesContent":["<script setup>\nimport { onMounted, ref } from 'vue'\nimport { apiPost,apiPoint } from '@/common/api'\n\n//  QR\nimport { QrcodeStream } from 'vue-qrcode-reader'\n\nconst isScanning = ref(false)\nconst error = ref('')\n\nconst startScan = () => {\n\nif (!amountInput.value) {\n    alert('입금액을 입력해주세요')\n    return\n  }\n\n  if(amountInput.value > memberPoint.value) {\n    alert('잔액이 부족합니다.')\n    return\n}\n\n  isScanning.value = true\n  error.value = ''\n}\n\nconst onDetect = (detectedCodes) => {\n  const url = detectedCodes[0]?.rawValue\nif(url === sessionStorage.getItem('idnt_code')) {\n  handleDeposit()\n  } else {\n      isScanning.value = false\n      return alert('인증오류')\n    }\n  if (!url) return\n\n  isScanning.value = false\n//   router.push('/sign/' + url)\n}\n\nconst onError = (err) => {\n  error.value = '카메라 접근 실패'\n  console.error(err)\n  isScanning.value = false\n}\n\n\n//  QR\nconst points = ref([])\nconst page = ref(1)\nconst isLoading = ref(false)\nconst hasMore = ref(true)\n\nconst studentOptions = ref([])\nconst studentRole = ref([])\nconst studentRoleIdntCode = ref([])\nconst selectedStudent = ref(null)\nconst amountInput = ref(null)\n\nconst fetchPoints = async (v) => {\n  if (isLoading.value || !hasMore.value) return\n\n  const idnt_code = sessionStorage.getItem('idnt_code')\n  if (!idnt_code) return\n\n  isLoading.value = true\n\n  try {\n    const res = await apiPost('bank.php', {\n      mode: 'history',\n      idnt_code,\n      page: v || page.value,\n      rows: 10,\n    })\n\n    if (res.result === 'SUCCESS' && Array.isArray(res.data)) {\n      if (res.data.length === 0) {\n        hasMore.value = false\n      } else {\n        points.value.push(...res.data)\n        page.value++\n      }\n    } else {\n      hasMore.value = false\n    }\n  } catch (error) {\n    console.error('포인트 조회 실패:', error)\n    hasMore.value = false\n  } finally {\n    isLoading.value = false\n  }\n}\n\nconst fetchStudents = async () => {\n  const teacher = JSON.parse(sessionStorage.getItem('student'))?.teacher\n  if (!teacher) return\n\n  const res = await apiPost('member.php', {\n    mode: 'studentList',\n    teacher\n  })\n\n  if (res.result === 'SUCCESS') {\n    memberPoint.value = await apiPoint()\n    studentOptions.value = res.data.map(s => ({\n      label: s.student_name,\n      value: s.idnt_code\n    }))\n  }\n}\n\n\n\nconst roleStudent = async () => {\n  const teacher = JSON.parse(sessionStorage.getItem('student'))?.teacher\n  if (!teacher) return\n\n  const res = await apiPost('member.php', {\n    mode: 'studentRoleList',\n    teacher\n  })\n\n\n  if (res.result === 'SUCCESS') {\n    // 이름만 추출해서 문자열로 변환\n    studentRole.value = res.data.map(s => s.student_name).join(', ')\n    studentRoleIdntCode.value = res.data.map(s => s.idnt_code)\n  }\n}\n\nonMounted(async () => {\n\n  fetchPoints()\n  fetchStudents()\n  roleStudent()\n  window.addEventListener('scroll', handleScroll)\n\n  const point = await apiPoint()\n  memberPoint.value = point\n  console.log('내 포인트:', point)\n})\n\nconst handleScroll = () => {\n  const scrollPosition = window.scrollY + window.innerHeight\n  const bottomPosition = document.body.offsetHeight - 50\n  if (scrollPosition >= bottomPosition) {\n    fetchPoints()\n  }\n}\n\n\nconst memberPoint = ref(0)\nconst handleDeposit = async () => {\n  if (!amountInput.value) {\n    alert('입금액을 입력해주세요')\n    return\n  }\n  const res = await apiPost('bank.php', {\n    mode: 'penalty',\n    idnt_code: sessionStorage.getItem('idnt_code'),\n    point: parseInt(amountInput.value)\n  })\n\n  if (res.result === 'SUCCESS') {\n    alert('벌금 납부 완료')\n\n    // 리스트 초기화 및 다시 조회\n    page.value = 1\n    points.value = []\n    hasMore.value = true\n    await fetchPoints(1)\n\n    amountInput.value = null\n    selectedStudent.value = null\n    memberPoint.value = await apiPoint()\n  } else {\n    alert(res.message || '입금에 실패했습니다.')\n  }\n}\n\n</script>\n\n<template>\n  <div>\n    <h2 class=\"mb-3 font-bold\">벌금 납부 하기</h2>\n      <div>\n        <div class=\"mb-6 flex items-center gap-3\">\n        <div\n            class=\"flex-none rounded-full p-1 text-primary-500 bg-primary-500/10\"\n        >\n            <div class=\"h-1.5 w-1.5 rounded-full bg-current\"></div>\n        </div>\n        <h2 class=\"uppercase text-xs font-semibold text-gray-400\">\n            나의 잔액 {{ memberPoint }}\n        </h2>\n        </div>\n        <p class=\"mt-2 text-sm text-gray-600 dark:text-gray-400\">\n        납부할 벌금을 입력 후 QR코드로 인증 해 주세요\n        </p>\n        <div class=\"flex items-center gap-3 mt-6\">\n       <!-- <USelect\n          v-model=\"selectedStudent\"\n          :options=\"studentOptions\"\n          placeholder=\"학생 선택\"\n          class=\"w-40\"\n          size=\"lg\"\n        /> -->\n        <UInput\n            v-model=\"amountInput\"\n            placeholder=\"입금액을 입력하세요\"\n            icon=\"i-heroicons-currency-dollar\"\n            class=\"flex-1 text-right\"\n            input-class=\"text-right\"\n            type=\"tel\"\n            size=\"lg\"\n        />\n        <UButton label=\"납부하기\" size=\"lg\" color=\"black\" @click=\"startScan()\"/>\n        </div>\n        <div v-if=\"isScanning\">\n            <div style=\"background-color: #000; position: fixed; top:0; left:0; width:100%; height:100%; z-index:99; opacity: 0.6;\"></div>\n             <qrcode-stream\n             style=\"top:50%; left:50%; z-index:99; position: fixed; transform: translate(-50%,-50%); max-width:400px; max-height:400px;\"\n            @detect=\"onDetect\"\n            @error=\"onError\"\n        />\n        </div>\n    </div>\n    <div class=\"mt-10\">\n      <h2 class=\"uppercase text-xs font-semibold text-gray-400 mb-4\">최근 입출금내역</h2>\n      <div class=\"space-y-5\">\n        <div\n        v-for=\"item in points\"\n        :key=\"item.idx\"\n        class=\"flex items-center gap-4 dark:hover:text-gray-300 group\"\n        >\n        <span class=\"text-sm leading-none\">\n            {{ item.description }} ({{ item.point_type === 'save' ? '+' : '-' }}{{ item.point.toLocaleString() }}P)\n        </span>\n        <div class=\"flex-1 border-b border-dashed border-gray-300 dark:border-gray-800 group-hover:border-gray-700 mt-1.5\"></div>\n        <span class=\"text-xs text-gray-500 leading-none\">\n            {{ item.c_datetime }}\n        </span>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nexport default {\n  components: {\n    QrcodeStream: () => import('vue-qrcode-reader').then(m => m.QrcodeStream)\n  }\n}\n</script>"],"names":["error","_ssrRenderList","_ssrInterpolate"],"mappings":"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"}